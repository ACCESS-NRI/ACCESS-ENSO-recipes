# ESMValTool
# 
---
documentation:
  description: Reproducing ENSO feedback metrics by Yann Planton
  title: ENSO CLIVAR metrics - ENSO feedback
  authors:
    - chun_felicity
    # - sullivan_arnold
    # - gillet_zoe
  maintainer:
    - chun_felicity

datasets:
  - {dataset: ACCESS-ESM1-5, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: ACCESS-CM2, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: BCC-CSM2-MR, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: CAS-ESM2-0, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: CESM2-FV2, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: CESM2-WACCM-FV2, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: CESM2-WACCM, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: CESM2, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: CMCC-CM2-HR4, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: CMCC-CM2-SR5, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: CMCC-ESM2, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: CanESM5, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: FGOALS-g3, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: FIO-ESM-2-0, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: GISS-E2-1-H, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: MCM-UA-1-0, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: MIROC6, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: MPI-ESM-1-2-HAM, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: MPI-ESM1-2-HR, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: MPI-ESM1-2-LR, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: MRI-ESM2-0, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: NorCPM1, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: NorESM2-LM, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: NorESM2-MM, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: SAM0-UNICON, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}
  # - {dataset: TaiESM1, project: CMIP6, exp: historical, ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}

  # observations
  # - {dataset: HadISST, project: OBS, type: reanaly, tier: 2, mip: Omon}
  
  
preprocessors:
  base_east: &base #20sst, 21ssh
    custom_order: true # turned off degC is last - looks wrong
    convert_units:
      units: degC
    mask_landsea:
      mask_out: land
    anomalies:
      period: monthly
    detrend:
      dimension: time
      method: linear
    regrid:
      target_grid: 1x1 
      scheme: linear
    extract_region: &east
      start_longitude: 210.
      end_longitude: 270.
      start_latitude: -5.
      end_latitude: 5.
    area_statistics:
      operator: mean
 
  west: # all levels
    <<: *base
    convert_units:
      units: 1e-3 N/m2
    extract_region: &west
      start_longitude: 160.
      end_longitude: 210.
      start_latitude: -5.
      end_latitude: 5.

  taux_eqp: &eqp_lv3
    convert_units:
      units: 1e-3 N/m2
    mask_landsea:
      mask_out: land
    anomalies:
      period: monthly
    detrend:
      dimension: time
      method: linear
    regrid:
      target_grid: 1x1
      scheme: linear
    extract_region: &eqp
      start_longitude: 150.
      end_longitude: 270.
      start_latitude: -5.
      end_latitude: 5.
    meridional_statistics:
      operator: mean
    # rolling_window_statistics: # error with using longitude
    #   coordinate: longitude
    #   window_length: 30
    #   operator: mean
  
  ssh_eqp: #lvl3
    <<: *eqp_lv3
    convert_units:
      units: cm

  ssh_east:
    <<: *base
    convert_units:
      units: cm
  
  ssh_eqp_area:
    <<: *base
    custom_order: false
    convert_units:
      units: cm
    extract_region: #eqp
      <<: *eqp

  sst_eqp_merid: #lvl3
    <<: *eqp_lv3
    convert_units:
      units: degC
  hf_east:
    <<: *base
    convert_units:
      units: W m-2

diagnostics:
  diagnostic_metrics:
    description: run preprocessors on variables for ENSO metrics
    variables:
      ts_east:
        short_name: ts
        mip: Amon
        preprocessor: base_east
        additional_datasets:
          - {dataset: ERA-Interim, project: OBS6, type: reanaly, tier: 3, version: 1, start_year: 1979, end_year: 2014}

      ts_eqp:
        short_name: ts
        mip: Amon
        preprocessor: sst_eqp_merid
        additional_datasets:
          - {dataset: ERA-Interim, project: OBS6, type: reanaly, tier: 3, version: 1, start_year: 1979, end_year: 2014}

      tauu_west:
        short_name: tauu
        mip: Amon
        preprocessor: west
        additional_datasets: #time same for lin regress - check in diag
          - {dataset: NCEP-DOE-R2, project: OBS6, type: reanaly, tier: 2, version: 2, start_year: 1979, end_year: 2014} 

      tauu_eqp:
        short_name: tauu
        mip: Amon
        preprocessor: taux_eqp
        additional_datasets:
          - {dataset: NCEP-DOE-R2, project: OBS6, type: reanaly, tier: 2, start_year: 1979, end_year: 2014}
      
      ssh_east:
        short_name: zos
        mip: Omon
        preprocessor: ssh_east
        additional_datasets:
          - {dataset: CMEMS, project: OBS6, type: sat, tier: 2, version: SEALEVEL-GLO-PHY-L4, start_year: 1993, end_year: 2018}
      ssh_eqp:
        short_name: zos
        mip: Omon
        preprocessor: ssh_eqp
        additional_datasets:
          - {dataset: CMEMS, project: OBS6, type: sat, tier: 2, version: SEALEVEL-GLO-PHY-L4, start_year: 1993, end_year: 2018}
      ssh_eqp_area:
        short_name: zos
        mip: Omon
        preprocessor: ssh_eqp_area
        additional_datasets:
          - {dataset: CMEMS, project: OBS6, type: sat, tier: 2, version: SEALEVEL-GLO-PHY-L4, start_year: 1993, end_year: 2018}

      hfns:
        short_name: hfns
        mip: Amon
        derive: true # hfls+hfss ..#need to make negative for hfds
        preprocessor: hf_east

    scripts:
      plot_script:
        script: /home/189/fc6164/esmValTool/repos/ENSO_recipes/recipe_diagnostics/diagnostic_scripts/feedback_metrics.py

  # diag_collect:
  #   description: collect metrics
  #   variables:
  #     tos: #dummy variable to fill recipe requirements
  #       mip: Omon
  #   scripts:
  #     matrix_collect:
  #       script: /home/189/fc6164/esmValTool/repos/ENSO_recipes/recipe_diagnostics/diagnostic_scripts/matrix.py
  #       # above diagnostic name and script name
  #       diag_metrics: diagnostic_metrics/plot_script #cfg['work_dir']

